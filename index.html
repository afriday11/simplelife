<!DOCTYPE html>
<html>
<head>
    <title>LifeSim MVP</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&display=swap" rel="stylesheet">
    <style>
        body {
            background-color: #f7f9fc;
            margin: 0;
            padding: 0;
            font-family: 'Patrick Hand', cursive;
            min-height: 100vh;
            position: fixed;
            width: 100%;
            overflow: hidden;
        }

        #game-container {
            max-width: 600px;
            width: 100%;
            margin: 0 auto;
            padding: 15px;
            box-sizing: border-box;
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            height: 90vh;
            display: flex;
            flex-direction: column;
        }

        #stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-bottom: 10px;
            flex-shrink: 0;
        }

        @media (min-width: 480px) {
            #stats {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        .stat {
            padding: 12px;
            background: #fff;
            text-align: center;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            border: 2px solid #e0e0e0;
            font-size: 1.1em;
            transition: transform 0.2s;
        }

        .stat:hover {
            transform: translateY(-2px);
        }

        #story-log {
            flex: 1;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 12px;
            overflow-y: auto;
            margin-bottom: 10px;
            background: #fff;
            font-size: 1em;
            line-height: 1.4;
            -webkit-overflow-scrolling: touch;
        }

        #story-log div {
            margin-bottom: 8px;
            padding: 8px;
            border-radius: 8px;
            background: #f8f9fa;
        }

        #character-header {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 10px;
            flex-shrink: 0;
        }

        #avatar {
            font-size: 50px;
            text-align: center;
            margin: 5px 0;
            animation: bounce 1s infinite;
            margin: 0;
        }

        #character-info {
            flex-grow: 1;
        }

        #character-name {
            font-size: 1.4em;
            font-weight: bold;
            margin: 0;
            color: #333;
        }

        #character-age {
            font-size: 1.2em;
            color: #666;
            margin: 0;
        }

        button {
            width: 100%;
            padding: 12px 20px;
            font-size: 1.2em;
            font-family: 'Patrick Hand', cursive;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: background 0.3s, transform 0.2s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            flex-shrink: 0;
            margin-top: auto;
            margin-bottom: calc(env(safe-area-inset-bottom, 0px) + 10px);
        }

        button:hover {
            background: #45a049;
            transform: scale(1.02);
        }

        button:active {
            transform: scale(0.98);
        }

        /* Custom scrollbar */
        #story-log::-webkit-scrollbar {
            width: 8px;
        }

        #story-log::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        #story-log::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }

        #story-log::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal {
            background: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .modal h2 {
            margin-top: 0;
            color: #333;
        }

        .modal-stats {
            margin: 20px 0;
            padding: 15px;
            background: #f7f9fc;
            border-radius: 10px;
        }

        .new-life-btn {
            background: #4CAF50;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Patrick Hand', cursive;
            font-size: 1.2em;
            transition: background 0.3s;
        }

        .new-life-btn:hover {
            background: #45a049;
        }

        /* Add viewport-height fix for mobile browsers */
        @supports (-webkit-touch-callout: none) {
            #game-container {
                height: -webkit-fill-available;
            }
        }

        /* Adjust for mobile notches and bars */
        @supports (padding: max(0px)) {
            #game-container {
                padding-left: max(15px, env(safe-area-inset-left));
                padding-right: max(15px, env(safe-area-inset-right));
                padding-top: max(15px, env(safe-area-inset-top));
                padding-bottom: max(15px, env(safe-area-inset-bottom));
            }
        }

        #character-stats-table {
            margin-top: 15px;
            padding: 15px;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            border: 2px solid #e0e0e0;
        }

        #character-stats-table h3 {
            margin: 0 0 10px 0;
            color: #333;
            text-align: center;
        }

        #character-stats-table table {
            width: 100%;
            border-collapse: collapse;
        }

        #character-stats-table td {
            padding: 8px;
            border-bottom: 1px solid #eee;
        }

        #character-stats-table td:first-child {
            font-weight: bold;
            color: #666;
            width: 40%;
        }

        #character-stats-table td:last-child {
            color: #333;
        }

        /* Add styles for the choice popup */
        .choice-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .choice-content {
            background: white;
            padding: 20px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .choice-button {
            display: block;
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: none;
            border-radius: 8px;
            background: #4CAF50;
            color: white;
            font-size: 1.1em;
            cursor: pointer;
            transition: background 0.3s;
        }

        .choice-button:hover {
            background: #45a049;
        }

        #relationships-container {
            margin-top: 15px;
            padding: 15px;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            border: 2px solid #e0e0e0;
        }

        #relationships-container h3 {
            margin: 0 0 10px 0;
            color: #333;
            text-align: center;
        }

        .relationship-item {
            padding: 8px;
            margin: 5px 0;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .relationship-status {
            font-style: italic;
            color: #666;
        }

        .relationship-level {
            font-size: 0.9em;
            color: #888;
        }
    </style>
</head>
<body>
    <div class="modal-overlay" id="deathModal">
        <div class="modal">
            <h2>ðŸ’€ Game Over ðŸ’€</h2>
            <div class="modal-stats" id="deathStats">
                <!-- Stats will be inserted here -->
            </div>
            <button class="new-life-btn" onclick="startNewLife()">Start New Life</button>
        </div>
    </div>

    <div id="game-container">
        <div id="character-header">
            <div id="avatar">ðŸ‘¶</div>
            <div id="character-info">
                <div id="character-name"></div>
                <div id="character-age"></div>
            </div>
        </div>
        <div id="stats">
            <div class="stat" id="happiness">Happiness: 50</div>
            <div class="stat" id="health">Health: 50</div>
            <div class="stat" id="smarts">Smarts: 50</div>
            <div class="stat" id="looks">Looks: 50</div>
        </div>
        <div id="story-log"></div>
        <button onclick="advanceYear()">+ Year</button>
        
        <!-- New Character Stats Table -->
        <div id="relationships-container">
            <h3>Relationships</h3>
            <div id="relationships-list">
                <!-- Relationships will be added here dynamically -->
            </div>
        </div>
        <div id="character-stats-table">
            <h3>Character Stats</h3>
            <table>
                <tr>
                    <td>Gender:</td>
                    <td id="char-gender">-</td>
                </tr>
                <tr>
                    <td>Personality:</td>
                    <td id="char-personality">-</td>
                </tr>
                <tr>
                    <td>Job:</td>
                    <td id="char-job">-</td>
                </tr>
                <tr>
                    <td>Education:</td>
                    <td id="char-education">-</td>
                </tr>
                <tr>
                    <td>Childhood Memory:</td>
                    <td id="char-memory">-</td>
                </tr>
                <tr>
                    <td>Favorite Color:</td>
                    <td id="char-color">-</td>
                </tr>
                <tr>
                    <td>Greatest Fear:</td>
                    <td id="char-fear">-</td>
                </tr>
                <tr>
                    <td>Best Friend:</td>
                    <td id="char-friend">-</td>
                </tr>
                <tr>
                    <td>Favorite Subject:</td>
                    <td id="char-subject">-</td>
                </tr>
                <tr>
                    <td>Talents:</td>
                    <td id="char-talents">-</td>
                </tr>
                <tr>
                    <td>Hobbies:</td>
                    <td id="char-hobbies">-</td>
                </tr>
                <tr>
                    <td>Dreams:</td>
                    <td id="char-dreams">-</td>
                </tr>
                <tr>
                    <td>Quirk:</td>
                    <td id="char-quirk">-</td>
                </tr>
            </table>
        </div>
    </div>

    <!-- Add this HTML for the choice popup -->
    <div class="choice-modal" id="choiceModal">
        <div class="choice-content">
            <h3 id="choiceTitle">Make a Choice</h3>
            <p id="choiceDescription">What will you do?</p>
            <div id="choiceButtons">
                <!-- Buttons will be added dynamically -->
            </div>
        </div>
    </div>

    <script>
            // Name Lists (add at bottom of file)
            const firstNames = [
            "James", "Emma", "Oliver", "Sophia", "William",
            "Isabella", "Henry", "Charlotte", "Alexander", "Mia",
            "Benjamin", "Amelia", "Lucas", "Harper", "Theodore",
            "Evelyn", "Daniel", "Abigail", "Joseph", "Elizabeth",
            "Samuel", "Sofia", "David", "Victoria", "Andrew"
        ];

        const europeanLastNames = [
            { name: "Smith", origin: "european" },
            { name: "Johnson", origin: "european" },
            { name: "Williams", origin: "european" },
            { name: "Brown", origin: "european" },
            { name: "Jones", origin: "european" },
            { name: "Garcia", origin: "european" },
            { name: "Miller", origin: "european" },
            { name: "Davis", origin: "european" },
            { name: "Rodriguez", origin: "european" },
            { name: "Martinez", origin: "european" },
            { name: "Anderson", origin: "european" },
            { name: "Taylor", origin: "european" },
            { name: "Thomas", origin: "european" },
            { name: "Moore", origin: "european" },
            { name: "Martin", origin: "european" },
            { name: "Jackson", origin: "european" },
            { name: "Thompson", origin: "european" },
            { name: "White", origin: "european" },
            { name: "Lopez", origin: "european" },
            { name: "Lee", origin: "european" },
            { name: "Harris", origin: "european" },
            { name: "Clark", origin: "european" },
            { name: "Lewis", origin: "european" },
            { name: "Robinson", origin: "european" },
            { name: "Walker", origin: "european" }
        ];

        // Game State
        function initializeState() {
            // Helper function to get random personality type
            const personalities = [
                "Adventurous", "Creative", "Analytical", "Empathetic",
                "Ambitious", "Cheerful", "Introverted", "Extroverted"
            ];
            
            // Add quirk to initial state
            const quirks = [
                "Always talks with their hands",
                "Can't stand the sound of chewing",
                "Has an infectious laugh that makes everyone smile",
                "Sneezes exactly three times in a row, every time",
                "Absolutely refuses to eat anything green",
                "Has a slight nervous twitch when excited",
                "Can fall asleep anywhere, anytime",
                "Whistles unconsciously when concentrating",
                "Always needs to organize things by color",
                "Has an uncanny ability to find lost items"
            ];
            
            // Generate 10 potential relationships
            const potentialRelationships = Array(10).fill(null).map(() => generatePerson());
            
            return {
                // Basic info (set at birth)
                name: generateRandomName(),
                gender: Math.random() < 0.5 ? "Male" : "Female",
                personality: personalities[Math.floor(Math.random() * personalities.length)],
                year: 0,
                age: 0,
                
                // Visual
                avatar: 'ðŸ‘¶',
                
                // Core stats
                 stats: {
                    happiness: 50,
                    health: 50,
                    smarts: 50,
                    looks: 50
                },

                // Life events and characteristics (filled as they grow)
                job: null,
                education: null,
                childhoodMemory: null,
                favoriteColor: null,
                greatestFear: null,
                relationships: [], // [{person: Person, status: "friend", level: 50}]
                achievements: [],
                talents: [],
                dreams: null,
                bestFriend: null,
                favoriteSubject: null,
                hobbies: [],
                
                // Game end
                causeOfDeath: null,
                quirk: quirks[Math.floor(Math.random() * quirks.length)],
                pets: [],  // Array to store pets: [{type: "Dog", name: "Max"}, ...]
                potentialRelationships: potentialRelationships,
            };
        }

        let state = initializeState();
        // Event System
        const events = [
            // Hobby Discovery Event
            {
                weight: 1,
                title: "New Hobby",
                description: "You have some free time. What would you like to try?",
                minAge: 16,
                maxAge: 90,
                choices: [
                    {
                        text: "Start collecting rare bugs",
                        effect: { happiness: 5, smarts: 8, health: -2 },
                        result: "You've become fascinated with entomology! Your parents are less excited about the bugs in jars.",
                        onSelect: (state) => { state.hobbies.push("Bug collecting") }
                    },
                    {
                        text: "Learn magic tricks",
                        effect: { happiness: 8, looks: 5, smarts: 3 },
                        result: "You're becoming quite the entertainer! Your card tricks are actually impressive.",
                        onSelect: (state) => { state.hobbies.push("Magic tricks") }
                    },
                    {
                        text: "Start a rock band",
                        effect: { happiness: 10, health: -3, looks: 5 },
                        result: "Your garage band isn't great, but you're having the time of your life!",
                        onSelect: (state) => { state.hobbies.push("Playing music") }
                    }
                ]
            },

            // Sickness Event
            {
                weight: 1,
                title: "Feeling Sick",
                description: "You're not feeling well. What do you do?",
                minAge: 16,
                maxAge: 100,
                choices: [
                    {
                        text: "Ignore it and go to school/work anyway",
                        effect: { health: -15, happiness: -10, smarts: 2 },
                        result: "You pushed through but got much sicker. Not your best decision.",
                        onSelect: (state) => { state.achievements.push("Iron Will") }
                    },
                    {
                        text: "Take medicine and rest",
                        effect: { health: -5, happiness: -3 },
                        result: "You recovered after a few days of rest.",
                        onSelect: null
                    },
                    {
                        text: "Try grandma's secret remedy",
                        effect: { health: -8, happiness: 5 },
                        result: "It tasted horrible but somehow made you feel better... eventually.",
                        onSelect: null
                    }
                ]
            },

            // Exam Cheating Event
            {
                weight: 2,
                title: "Difficult Exam",
                description: "You're struggling with a really important exam. What do you do?",
                minAge: 16,
                maxAge: 25,
                choices: [
                    {
                        text: "Study all night",
                        effect: { smarts: 15, health: -5, happiness: -3 },
                        result: "You aced the exam but you're exhausted!",
                        onSelect: (state) => { state.achievements.push("Academic Excellence") }
                    },
                    {
                        text: "Try to peek at your neighbor's answers",
                        effect: { smarts: -5, happiness: -10 },
                        result: "You got caught cheating. This will have consequences...",
                        onSelect: (state) => { state.achievements.push("Caught Cheating") }
                    },
                    {
                        text: "Write answers on your water bottle",
                        effect: { happiness: -5 },
                        result: "You got away with it, but the guilt is eating at you.",
                        onSelect: null
                    }
                ]
            },

            // Love Event
            {
                weight: 1,
                title: "Crush Alert",
                requirements: {
                    minAge: 13,
                    maxAge: 80,
                    isSingle: true,
                    minHappiness: 30
                },
                description: "Someone special has caught your eye. How do you approach them?",
                choices: [
                    {
                        text: "Write a romantic poem",
                        effect: { happiness: 10, smarts: 5, looks: -2 },
                        result: "They were touched by your creativity! A beautiful relationship begins.",
                        onSelect: (state) => {
                            state.relationships.push({
                                person: generatePerson(),
                                status: "dating",
                                level: 50
                            });
                        }
                    },
                    {
                        text: "Try to impress them with sports",
                        effect: { health: 8, happiness: 5, looks: 5 },
                        result: "You showed off your athletic skills and caught their attention!",
                        onSelect: (state) => {
                            state.relationships.push({
                                person: generatePerson(),
                                status: "dating",
                                level: 50
                            });
                        }
                    },
                    {
                        text: "Ask their friends about them",
                        effect: { happiness: -5 },
                        result: "They found out you were asking about them. How embarrassing!",
                        onSelect: null
                    }
                ]
            },

            // Dream Job Event
            {
                weight: 1,
                title: "Career Opportunity",
                description: "Multiple job offers! Which path do you choose?",
                minAge: 18,
                maxAge: 65,
                choices: [
                    {
                        text: "Tech startup CEO",
                        effect: { happiness: 15, smarts: 10, health: -8 },
                        result: "You're leading a promising startup! The stress is intense but so is the excitement.",
                        onSelect: (state) => { state.job = "Tech Startup CEO" }
                    },
                    {
                        text: "Professional food critic",
                        effect: { happiness: 12, health: -5, looks: -3 },
                        result: "You're living the dream, trying the best restaurants in town!",
                        onSelect: (state) => { state.job = "Food Critic" }
                    },
                    {
                        text: "International spy",
                        effect: { happiness: 8, health: -2, smarts: 15 },
                        result: "Your life is now filled with intrigue and adventure!",
                        onSelect: (state) => { state.job = "Government Agent" }
                    }
                ]
            },

            // Workout Event
            {
                weight: 1,
                title: "Fitness Journey",
                description: "You want to get in shape. Which unusual method do you try?",
                minAge: 12,
                maxAge: 80,
                choices: [
                    {
                        text: "Underwater basket weaving aerobics",
                        effect: { health: 12, looks: 8, happiness: 5 },
                        result: "This weird workout actually worked! You're in great shape!",
                        onSelect: (state) => { state.hobbies.push("Underwater Aerobics") }
                    },
                    {
                        text: "Extreme dog walking",
                        effect: { health: 15, happiness: 10, looks: 3 },
                        result: "Running with dogs through obstacle courses is surprisingly effective!",
                        onSelect: (state) => { state.hobbies.push("Extreme Dog Walking") }
                    },
                    {
                        text: "Competitive office chair racing",
                        effect: { health: 5, happiness: 15, looks: -2 },
                        result: "Not the best workout, but you're having a blast!",
                        onSelect: (state) => { state.hobbies.push("Chair Racing") }
                    }
                ]
            },
            //Make a friend
            {
                weight: 10,
                message: "Test event - filler",
                effect: { happiness: 5, looks: 3 },
                minAge: 1,
                maxAge: 80
            },

            // Meeting New Person Event
            {
                weight: 3,
                title: "New Connection",
                requirements: {
                    minAge: 5,
                    maxAge: 90,
                    minHappiness: 20 // Need some basic happiness to be social
                },
                description: function(state) {
                    // First, ensure potentialRelationships exists
                    if (!state.potentialRelationships) {
                        state.potentialRelationships = [];
                    }

                    // Generate a new person if we have less than 3 potential relationships
                    if (state.potentialRelationships.length < 3) {
                        const newPerson = generatePerson();
                        state.potentialRelationships.push(newPerson);
                    }

                    // Get a random stranger from potential relationships
                    const availableStrangers = state.potentialRelationships.filter(person => 
                        !state.relationships.some(rel => rel.person.id === person.id)
                    );

                    // Select a random stranger
                    const person = availableStrangers[Math.floor(Math.random() * availableStrangers.length)];
                    
                    // Store the selected person in the event state
                    this.selectedPerson = person;
                    
                    return `You meet ${person.name}, a ${person.personality.toLowerCase()} person who loves ${person.interests[0].toLowerCase()}. How do you approach them?`;
                },
                minAge: 5,
                maxAge: 90,
                choices: [
                    {
                        text: "Be friendly and open",
                        effect: { happiness: 5 },
                        result: function(state, event) {
                            const person = event.selectedPerson;
                            return `You had an amazing time with ${person.name}! Your friendship has grown stronger.`;
                        },
                        onSelect: (state, event) => { 
                            const person = event.selectedPerson;
                            addRelationship(state, person, "acquaintance", 20);
                        }
                    },
                    {
                        text: "Share common interests",
                        effect: { happiness: 8, smarts: 2 },
                        result: function(state, event) {
                            const person = event.selectedPerson;
                            return `You and ${person.name} really hit it off talking about ${person.interests[0]}!`;
                        },
                        onSelect: (state, event) => {
                            const person = event.selectedPerson;
                            addRelationship(state, person, "friend", 30);
                        }
                    },
                    {
                        text: "Keep your distance",
                        effect: { happiness: -1 },
                        result: function(state, event) {
                            const person = event.selectedPerson;
                            return `You decide to avoid ${person.name}. They seem a bit hurt.`;
                        },
                        onSelect: (state, event) => {
                            const person = event.selectedPerson;
                            addRelationship(state, person, "stranger", -10);
                        }
                    }
                ]
            },

            // Friendship Development Event
            {
                weight: 5,
                title: "Deepening Friendship",
                requirements: {
                    minAge: 5,
                    maxAge: 90,
                    hasFriends: true,
                    minHappiness: 30 // Need to be somewhat happy to develop friendships
                },
                description: function(state) {
                    // Check if we have any friends first
                    const friends = state.relationships.filter(rel => 
                        ["friend", "good_friend","best_friend"].includes(rel.status)
                    );
                    
                    if (friends.length === 0) {
                        // Apply the happiness penalty
                        state.stats.happiness = Math.max(0, state.stats.happiness - 10);
                        updateUI();
                        
                        // Immediately fetch another event and show/apply it
                        // after this function finishes returning.
                        setTimeout(() => {
                            const newEvent = getRandomEvent();  // Use your existing function
                            if (newEvent.choices) {
                                // If the new event has choices, show them
                                showChoice(newEvent);
                            } else {
                                // Otherwise, just apply the event's effect
                                applyEventEffects(newEvent.effect);
                                if (newEvent.onTrigger) {
                                    newEvent.onTrigger(state);
                                }
                                // Log the new event
                                const log = document.getElementById('story-log');
                                log.insertAdjacentHTML('afterbegin', 
                                    `<div><strong>Age ${state.age}</strong>: ${newEvent.message}</div>`
                                );
                                updateUI();
                            }
                        }, 0);
                        
                        // Return a message so you still see something in the UI if needed
                        return "You find yourself with no real friends. The loneliness weighs heavily on you. Another event is triggered insteadâ€¦";
                    }
                    
                    // Otherwise, proceed normally
                    const randomFriend = friends[Math.floor(Math.random() * friends.length)];
                    this.selectedPerson = randomFriend.person;
                    return `Your friend ${this.selectedPerson.name} invites you to ${this.selectedPerson.interests[0].toLowerCase()} together. What do you do?`;
                },
                minAge: 5,
                maxAge: 90,
                choices: [
                    {
                        text: "Enthusiastically join them",
                        effect: { happiness: 10 },
                        result: function(state, event) {
                            const person = event.selectedPerson;
                            return `You had an amazing time with ${person.name}! Your friendship has grown stronger.`;
                        },
                        onSelect: (state, event) => {
                            const person = event.selectedPerson;
                            if (person) {
                                upgradeRelationship(state, person, "good_friend");
                            }
                        }
                    },
                    {
                        text: "Make an excuse",
                        effect: { happiness: -3 },
                        result: function(state, event) {
                            const person = event.selectedPerson;
                            return `${person.name} seems disappointed. Your friendship has cooled a bit.`;
                        },
                        onSelect: (state, event) => {
                            const person = event.selectedPerson;
                            if (person) {
                                downgradeRelationship(state, person);
                            }
                        }
                    },
                    {
                        text: "Suggest a different activity",
                        effect: { happiness: 5 },
                        result: function(state, event) {
                            const person = event.selectedPerson;
                            return `${person.name} appreciates your honesty and you find a compromise.`;
                        },
                        onSelect: (state, event) => {
                            const person = event.selectedPerson;
                            if (person) {
                                addRelationshipPoints(state, person, 5);
                            }
                        }
                    }
                ]
            },

            // Job-related event
            {
                weight: 3,
                title: "Promotion Opportunity",
                requirements: {
                    minAge: 18,
                    maxAge: 100,
                    hasJob: true,
                    minSmarts: 60,
                    minHappiness: 20
                },
                description: "Your boss has noticed your hard work...",
                choices: [
                    {
                        text: "Work extra hours to prove yourself",
                        effect: { happiness: -5, smarts: 10, health: -5 },
                        result: "Your dedication paid off! You got the promotion!",
                        onSelect: (state) => {
                            state.money += 5000;
                            if (state.job) {
                                state.job.level = (state.job.level || 1) + 1;
                            }
                        }
                    },
                    {
                        text: "Present your innovative ideas",
                        effect: { happiness: 5, smarts: 5 },
                        result: "Your creativity impressed everyone! Promotion granted!",
                        onSelect: (state) => {
                            state.money += 5000;
                            if (state.job) {
                                state.job.level = (state.job.level || 1) + 1;
                            }
                        }
                    },
                    {
                        text: "Decline the opportunity",
                        effect: { happiness: -3 },
                        result: "You decided to stay in your current position.",
                        onSelect: null
                    }
                ]
            },

            // Education event
            {
                weight: 7,
                title: "College Opportunity",
                requirements: {
                    minAge: 18,
                    maxAge: 25,
                    hasHighSchool: true,
                    minSmarts: 50,
                    minMoney: 5000
                },
                description: "You have the opportunity to go to college..."
            },

            // Health event
            {
                weight: 2,
                title: "Marathon Training",
                requirements: {
                    minAge: 16,
                    maxAge: 70,
                    minHealth: 70,
                    minHappiness: 50
                },
                description: "You feel inspired to train for a marathon..."
            }
        ];

        // Add these pet arrays
        const petTypes = [
            "Dog",
            "Cat",
            "Hamster",
            "Parrot",
            "Fish",
            "Rabbit",
            "Guinea Pig",
            "Turtle"
        ];

        const petNames = [
            "Luna", "Max", "Bella", "Charlie", 
            "Lucy", "Milo", "Oliver", "Leo", 
            "Daisy", "Rocky", "Molly", "Bailey",
            "Coco", "Buddy", "Ruby", "Shadow",
            "Lily", "Oscar", "Ziggy", "Pepper"
        ];

        // Add new pet adoption events
        const petAdoptionEvents = [
            {
                weight: 1,
                message: "You adopted a pet!",
                effect: { happiness: 10 },
                minAge: 5,
                maxAge: 90,
                onTrigger: (state) => {
                    const petType = petTypes[Math.floor(Math.random() * petTypes.length)];
                    const petName = petNames[Math.floor(Math.random() * petNames.length)];
                    state.pets.push({ type: petType, name: petName });
                }
            }
        ];

        // Core Game Functions
        function getRandomEvent() {
            const eligibleEvents = events.filter(event => {
                // Check all requirements
                if (event.requirements) {
                    // Age requirements (existing)
                    if (state.age < event.requirements.minAge || state.age > event.requirements.maxAge) {
                        return false;
                    }
                    
                    // Job requirements
                    if (event.requirements.hasJob && !state.job) return false;
                    if (event.requirements.jobType && state.job !== event.requirements.jobType) return false;
                    
                    // Relationship requirements
                    if (event.requirements.isSingle && state.relationships.some(r => r.status === "married")) return false;
                    if (event.requirements.isMarried && !state.relationships.some(r => r.status === "married")) return false;
                    if (event.requirements.hasFriends && !state.relationships.some(r => ["friend", "good_friend", "best_friend"].includes(r.status))) return false;
                    
                    // Stat requirements
                    if (event.requirements.minSmarts && state.stats.smarts < event.requirements.minSmarts) return false;
                    if (event.requirements.minHealth && state.stats.health < event.requirements.minHealth) return false;
                    if (event.requirements.minHappiness && state.stats.happiness < event.requirements.minHappiness) return false;
                    if (event.requirements.minLooks && state.stats.looks < event.requirements.minLooks) return false;
                    
                    // Education requirements
                    if (event.requirements.hasHighSchool && !state.education?.highSchool) return false;
                    if (event.requirements.hasCollege && !state.education?.college) return false;
                    
                    // Asset/Money requirements
                    if (event.requirements.minMoney && state.money < event.requirements.minMoney) return false;
                    if (event.requirements.hasHouse && !state.assets?.house) return false;
                    if (event.requirements.hasCar && !state.assets?.car) return false;
                }
                
                return true;
            });
            
            const weightedEvents = eligibleEvents.flatMap(event => 
                Array(event.weight).fill(event)
            );
            
            return weightedEvents[Math.floor(Math.random() * weightedEvents.length)];
        }

        function updateAvatar() {
            const avatars = {
                0: 'ðŸ‘¶',  // Baby
                3: 'ðŸ‘§',  // Child
                13: 'ðŸ§‘', // Teen
                20: 'ðŸ‘©', // Adult
                60: 'ðŸ‘µ'  // Elder
            };
            
            state.avatar = Object.entries(avatars).reduce((acc, [age, emoji]) => {
                return state.age >= age ? emoji : acc;
            }, state.avatar);
        }

        function applyEventEffects(effects) {
            Object.entries(effects).forEach(([stat, value]) => {
                state.stats[stat] = Math.max(0, Math.min(100, state.stats[stat] + value));
            });
        }

        // UI Updates
        function updateUI() {
            document.getElementById('avatar').textContent = state.avatar;
            document.getElementById('character-name').textContent = state.name;
            document.getElementById('character-age').textContent = `Age: ${state.age}`;
            document.getElementById('happiness').textContent = `Happiness: ${state.stats.happiness}`;
            document.getElementById('health').textContent = `Health: ${state.stats.health}`;
            document.getElementById('smarts').textContent = `Smarts: ${state.stats.smarts}`;
            document.getElementById('looks').textContent = `Looks: ${state.stats.looks}`;
            
            // Update character stats table with visibility logic
            const statsMapping = {
                'char-gender': state.gender,
                'char-personality': state.personality,
                'char-job': state.job,
                'char-education': state.education,
                'char-memory': state.childhoodMemory,
                'char-color': state.favoriteColor,
                'char-fear': state.greatestFear,
                'char-friend': state.bestFriend,
                'char-subject': state.favoriteSubject,
                'char-talents': state.talents.length ? state.talents.join(", ") : null,
                'char-hobbies': state.hobbies.length ? state.hobbies.join(", ") : null,
                'char-dreams': state.dreams,
                'char-quirk': state.quirk
            };

            // Update each stat and show/hide its row
            for (const [elementId, value] of Object.entries(statsMapping)) {
                const element = document.getElementById(elementId);
                const row = element.closest('tr'); // Get the parent table row
                
                if (value) {
                    // Show and update rows with values
                    row.style.display = '';
                    element.textContent = value;
                } else {
                    // Hide empty rows
                    row.style.display = 'none';
                }
            }

            // Update relationships display
            const relationshipsList = document.getElementById('relationships-list');
            relationshipsList.innerHTML = ''; // Clear existing relationships

            if (state.relationships.length === 0) {
                relationshipsList.innerHTML = '<div class="relationship-item">No relationships yet</div>';
            } else {
                state.relationships.forEach(rel => {
                    const relationshipEmoji = getRelationshipEmoji(rel.status);
                    const relationshipDiv = document.createElement('div');
                    relationshipDiv.className = 'relationship-item';
                    relationshipDiv.innerHTML = `
                        <span>${relationshipEmoji} ${rel.person.name}</span>
                        <span class="relationship-status">${formatRelationshipStatus(rel.status)}</span>
                        <span class="relationship-level">Level: ${rel.level}</span>
                    `;
                    relationshipsList.appendChild(relationshipDiv);
                });
            }
        }

        // Main Game Loop
        function advanceYear() {
            state.year++;
            state.age++;
            
            const event = getRandomEvent();
            
            // Log the event that was selected
            console.log("Event fired:", event.title);
            console.log("Year:", state.year);
            
            if (event.choices) {
                // If event has choices, show the choice modal
                showChoice(event);
            } else {
                // Handle regular events
                applyEventEffects(event.effect);
                if (event.onTrigger) {
                    event.onTrigger(state);
                }
                
                const log = document.getElementById('story-log');
                log.insertAdjacentHTML('afterbegin', 
                    `<div><strong>Age ${state.age}</strong>: ${event.message}</div>`);
            }
            
            updateAvatar();
            
            if (!checkDeath()) {
                updateUI();
            }
        }

        // Initial setup
        updateUI();

        function checkDeath() {
            if (state.stats.health <= 0) {
                state.causeOfDeath = "Poor health";
                showDeathModal();
                return true;
            }
            return false;
        }

        function showDeathModal() {
            const modal = document.getElementById('deathModal');
            const statsDiv = document.getElementById('deathStats');
            
            // Calculate lifetime stats
            const statsHTML = `
                <p>Age at death: ${state.age} years</p>
                <p>Final Stats:</p>
                <p>Happiness: ${state.stats.happiness}</p>
                <p>Health: ${state.stats.health}</p>
                <p>Smarts: ${state.stats.smarts}</p>
                <p>Looks: ${state.stats.looks}</p>
                <p>Cause of death: ${state.causeOfDeath}</p>
            `;
            
            statsDiv.innerHTML = statsHTML;
            modal.style.display = 'flex';
        }

        function startNewLife() {
            // Reset the game state
            state = initializeState();
            
            // Clear the story log
            const log = document.getElementById('story-log');
            log.innerHTML = '';
            
            // Hide the death modal
            document.getElementById('deathModal').style.display = 'none';
            
            // Update UI
            updateUI();
        }

        // Function to generate random name
        function generateRandomName() {
            const firstName = firstNames[Math.floor(Math.random() * firstNames.length)];
            const lastName = europeanLastNames[Math.floor(Math.random() * europeanLastNames.length)].name;
            return `${firstName} ${lastName}`;
        }

        // Add choice handling functions
        function showChoice(event) {
            const modal = document.getElementById('choiceModal');
            const title = document.getElementById('choiceTitle');
            const description = document.getElementById('choiceDescription');
            const buttonsContainer = document.getElementById('choiceButtons');
            
            title.textContent = event.title || 'Make a Choice';
            description.textContent = typeof event.description === 'function' 
                ? event.description(state) 
                : event.description;
            
            buttonsContainer.innerHTML = '';
            
            event.choices.forEach(choice => {
                const button = document.createElement('button');
                button.className = 'choice-button';
                button.textContent = choice.text;
                button.onclick = () => {
                    handleChoice(choice, event);
                    modal.style.display = 'none';
                };
                buttonsContainer.appendChild(button);
            });
            
            modal.style.display = 'flex';
        }

        function handleChoice(choice, event) {
            applyEventEffects(choice.effect);
            
            if (choice.onSelect) {
                choice.onSelect(state, event);
            }
            
            const resultText = typeof choice.result === 'function' 
                ? choice.result(state, event) 
                : choice.result;
            
            const log = document.getElementById('story-log');
            log.insertAdjacentHTML('afterbegin', 
                `<div><strong>Age ${state.age}</strong>: ${resultText}</div>`);
            
            updateUI();
        }

        // Person generator
        function generatePerson() {
            const personalities = ["Shy", "Outgoing", "Funny", "Serious", "Creative", "Athletic", "Nerdy", "Dramatic"];
            const interests = ["Video Games", "Sports", "Art", "Music", "Reading", "Cooking", "Travel", "Science"];
            
            return {
                id: Math.random().toString(36).substr(2, 9),
                name: generateRandomName(),
                age: Math.floor(Math.random() * 20) + 5, // 5-25 years old, later we'll want to change this so they age with you
                gender: Math.random() < 0.5 ? "Male" : "Female",
                personality: personalities[Math.floor(Math.random() * personalities.length)],
                interests: [interests[Math.floor(Math.random() * interests.length)]],
                stats: {
                    happiness: Math.floor(Math.random() * 50) + 50,
                    smarts: Math.floor(Math.random() * 50) + 50,
                    looks: Math.floor(Math.random() * 50) + 50
                },
                relationshipStatus: "stranger" // stranger, acquaintance, friend, good_friend, best_friend, enemy, dating, married, divorced
            };
            console.log(name);
            console.log(personalities);
            console.log(interests);
        }
        // Helper functions for relationship management
        function getRandomStranger(state) {
            return state.potentialRelationships.find(person => 
                !state.relationships.some(rel => rel.person.id === person.id)
            );
        }

        function getRandomFriend(state) {
            const friends = state.relationships.filter(rel => 
                ["friend", "good_friend", "best_friend"].includes(rel.status)
            );
            return friends[Math.floor(Math.random() * friends.length)]?.person;
        }

        function addRelationship(state, person, status, level) {
            state.relationships.push({
                person: person,
                status: status,
                level: level
            });
        }

        function upgradeRelationship(state, person, newStatus) {
            const rel = state.relationships.find(r => r.person.id === person.id);
            if (rel) {
                rel.status = newStatus;
                rel.level += 10;
            }
        }

        function downgradeRelationship(state, person) {
            const rel = state.relationships.find(r => r.person.id === person.id);
            if (rel) {
                rel.level -= 10;
                if (rel.level < 0) {
                    rel.status = "enemy";
                }
            }
        }

        function addRelationshipPoints(state, person, points) {
            const rel = state.relationships.find(r => r.person.id === person.id);
            if (rel) {
                rel.level += points;
            }
        }

        // Helper function to get emoji for relationship status
        function getRelationshipEmoji(status) {
            const emojis = {
                'stranger': 'ðŸ¤”',
                'acquaintance': 'ðŸ‘‹',
                'friend': 'ðŸ˜Š',
                'good_friend': 'ðŸ¤—',
                'best_friend': 'ðŸ’«',
                'enemy': 'ðŸ˜ ',
                'dating': 'ðŸ’•',
                'married': 'ðŸ’‘',
                'divorced': 'ðŸ’”'
            };
            return emojis[status] || 'ðŸ‘¤';
        }

        // Helper function to format relationship status
        function formatRelationshipStatus(status) {
            return status.split('_')
                .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                .join(' ');
        }
    </script>
</body>
</html>