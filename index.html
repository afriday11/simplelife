<!DOCTYPE html>
<html>
<head>
    <title>RogueLife</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&display=swap" rel="stylesheet">
    <link href="styles.css" rel="stylesheet">
    <script>
        // Dark mode functionality
        function initDarkMode() {
            // Check for saved dark mode preference
            const darkMode = localStorage.getItem('darkMode') === 'true';
            
            // Apply saved preference
            if (darkMode) {
                document.documentElement.setAttribute('data-theme', 'dark');
                document.getElementById('darkModeToggle').innerHTML = '‚òÄÔ∏è Light';
            }
        }

        function toggleDarkMode() {
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            if (isDark) {
                document.documentElement.removeAttribute('data-theme');
                localStorage.setItem('darkMode', 'false');
                document.getElementById('darkModeToggle').innerHTML = 'üåô Dark';
            } else {
                document.documentElement.setAttribute('data-theme', 'dark');
                localStorage.setItem('darkMode', 'true');
                document.getElementById('darkModeToggle').innerHTML = '‚òÄÔ∏è Light';
            }
        }

        // Initialize dark mode on page load
        document.addEventListener('DOMContentLoaded', initDarkMode);
    </script>
</head>
<body>
    <!-- Dark Mode Toggle Button -->
    <button id="darkModeToggle" onclick="toggleDarkMode()">üåô Dark</button>

    <!-- Minimal Characters Button and Modal -->
    <button id="showCharactersButton" style="position: fixed; top: 10px; right: 10px; z-index: 1100; padding: 5px 10px; background: #4CAF50; color: white; border: none; border-radius: 4px;">Characters</button>
    <div id="charactersModal" style="display: none; position: fixed; top: 50px; right: 20px; left: auto; z-index: 1500; background-color: white; padding: 10px; border: 1px solid #ccc; max-height: 80%; overflow-y: auto;">
        <button id="closeCharactersModal" style="position: absolute; top: 2px; right: 2px;">Close</button>
        <h3>Town Characters</h3>
        <div id="charactersContent"></div>
    </div>

    <div class="modal-overlay" id="deathModal">
        <div class="modal">
            <h2>üíÄ Game Over üíÄ</h2>
            <div class="modal-stats" id="deathStats">
                <!-- Stats will be inserted here -->
            </div>
            <button class="new-life-btn" onclick="startNewLife()">Start New Life</button>
        </div>
    </div>

    <div id="game-container">
        <div id="character-header">
            <div id="avatar">üë∂</div>
            <div id="character-info">
                <div id="character-name"></div>
                <div id="character-age"></div>
                <div id="character-money"></div>
            </div>
        </div>
        <div id="stats">
            <div class="stat" id="happiness">Happiness: 50</div>
            <div class="stat" id="health">Health: 50</div>
            <div class="stat" id="smarts">Smarts: 50</div>
            <div class="stat" id="looks">Looks: 50</div>
        </div>
        <div id="story-log"></div>
        <div class="control-strip">
            <button class="control-button" onclick="showJobPanel()">Job</button>
            <button class="control-button" onclick="showAssetsPanel()">Assets</button>
            <button class="year-button" onclick="advanceYear()">
                <span class="plus">+</span>
                <span class="year-text">Year</span>
            </button>
            <button class="control-button" onclick="showRelationshipsPanel()">Relations</button>
            <button class="control-button" onclick="showStatsPanel()">Stats</button>
        </div>
        
        <!-- New Character Stats Table -->
        <div id="relationships-container">
            <h3>Relationships</h3>
            <div id="relationships-list">
                <!-- Relationships will be added here dynamically -->
            </div>
        </div>
        <div id="character-stats-table">
            <h3>Character Stats</h3>
            <table>
                <tr>
                    <td>Gender:</td>
                    <td id="char-gender">-</td>
                </tr>
                <tr>
                    <td>Personality:</td>
                    <td id="char-personality">-</td>
                </tr>
                <tr>
                    <td>Job:</td>
                    <td id="char-job">-</td>
                </tr>
                <tr>
                    <td>Education:</td>
                    <td id="char-education">-</td>
                </tr>
                <tr>
                    <td>Childhood Memory:</td>
                    <td id="char-memory">-</td>
                </tr>
                <tr>
                    <td>Favorite Color:</td>
                    <td id="char-color">-</td>
                </tr>
                <tr>
                    <td>Greatest Fear:</td>
                    <td id="char-fear">-</td>
                </tr>
                <tr>
                    <td>Best Friend:</td>
                    <td id="char-friend">-</td>
                </tr>
                <tr>
                    <td>Favorite Subject:</td>
                    <td id="char-subject">-</td>
                </tr>
                <tr>
                    <td>Talents:</td>
                    <td id="char-talents">-</td>
                </tr>
                <tr>
                    <td>Hobbies:</td>
                    <td id="char-hobbies">-</td>
                </tr>
                <tr>
                    <td>Dreams:</td>
                    <td id="char-dreams">-</td>
                </tr>
                <tr>
                    <td>Quirk:</td>
                    <td id="char-quirk">-</td>
                </tr>
            </table>
        </div>
    </div>

    <!-- Add this HTML for the choice popup -->
    <div class="choice-modal" id="choiceModal">
        <div class="choice-content">
            <h3 id="choiceTitle">Make a Choice</h3>
            <p id="choiceDescription">What will you do?</p>
            <div id="choiceButtons">
                <!-- Buttons will be added dynamically -->
            </div>
        </div>
    </div>

    <script src="dialogSystem.js"></script>
    <script src="characterGenerator.js"></script>
    <script src="timeHandler.js"></script>
    <script src="events.js"></script>
    <script>
        // Game State
        function initializeState() {
            // Helper function to get random personality type
            const personalities = [
                "Adventurous", "Creative", "Analytical", "Empathetic",
                "Ambitious", "Cheerful", "Introverted", "Extroverted"
            ];
            
            // Add quirk to initial state
            const quirks = [
                "Always talks with their hands",
                "Can't stand the sound of chewing",
                "Has an infectious laugh that makes everyone smile",
                "Sneezes exactly three times in a row, every time",
                "Absolutely refuses to eat anything green",
                "Has a slight nervous twitch when excited",
                "Can fall asleep anywhere, anytime",
                "Whistles unconsciously when concentrating",
                "Always needs to organize things by color",
                "Has an uncanny ability to find lost items"
            ];
            
            // Generate 10 potential relationships
            const potentialRelationships = Array(10).fill(null).map(() => generatePerson());
            
            return {
                // Basic info (set at birth)
                name: generateRandomName(),
                gender: Math.random() < 0.5 ? "Male" : "Female",
                personality: personalities[Math.floor(Math.random() * personalities.length)],
                age: 0,
                
                // Visual
                avatar: 'üë∂',
                
                // Core stats
                 stats: {
                    happiness: 50,
                    health: 50,
                    smarts: 50,
                    looks: 50
                },

                // Add money property
                money: 0,  // Start with 0 money

                // Life events and characteristics (filled as they grow)
                job: null,
                education: null,
                childhoodMemory: null,
                favoriteColor: null,
                greatestFear: null,
                relationships: [], // [{person: Person, status: "friend", level: 50}]
                achievements: [],
                talents: [],
                dreams: null,
                bestFriend: null,
                favoriteSubject: null,
                hobbies: [],
                
                // Game end
                causeOfDeath: null,
                quirk: quirks[Math.floor(Math.random() * quirks.length)],
                pets: [],  // Array to store pets: [{type: "Dog", name: "Max"}, ...]
                potentialRelationships: potentialRelationships,
                eventHistory: new EventHistory(),
                town: [], // Initialize empty town array
                
                // Birth year in global timeline
                birthYear: getGlobalYear()
            };
        }

        let state = initializeState();
        
        // Initialize town characters
        console.log("About to generate core characters"); // Debug log
        state.town = generateCoreCharacters(12);
        console.log("Generated town characters:", state.town); // Debug log

        // Characters modal functionality
        function updateCharactersModal() {
            const container = document.getElementById('charactersContent');
            container.innerHTML = ''; // Clear previous content
            console.log("Current state.town:", state.town); // Debug log
            if (state.town && state.town.length > 0) {
                state.town.forEach(character => {
                    const charDiv = document.createElement('div');
                    charDiv.style.borderBottom = "1px solid #eee";
                    charDiv.style.marginBottom = "8px";
                    charDiv.style.paddingBottom = "4px";
                    charDiv.innerHTML = `<strong>${character.name}</strong> 
                        (Age: ${character.age}, ${character.gender})<br>
                        Personality: ${character.personality}<br>
                        Stats: Happiness: ${character.stats.happiness}, Health: ${character.stats.health}, Smarts: ${character.stats.smarts}, Looks: ${character.stats.looks}`;
                    container.appendChild(charDiv);
                });
            } else {
                console.log("No characters found in state.town"); // Debug log
                container.innerHTML = 'No characters available';
            }
        }

        // Add event listeners for the characters modal
        document.addEventListener('DOMContentLoaded', function() {
            console.log("Setting up modal listeners"); // Debug log
            document.getElementById('showCharactersButton').addEventListener('click', function() {
                updateCharactersModal();
                document.getElementById('charactersModal').style.display = 'block';
            });

            document.getElementById('closeCharactersModal').addEventListener('click', function() {
                document.getElementById('charactersModal').style.display = 'none';
            });
        });

        // Initialize a set to track fired events
        let firedEvents = new Set();

        function getRandomEvent() {
            const eligibleEvents = gameEvents.filter(event => {
                // Handle old event format
                if (event.minAge !== undefined) {
                    return state.age >= event.minAge && state.age <= event.maxAge;
                }
                
                // Handle new event format
                if (event.requirements) {
                    // Age requirements
                    if (event.requirements.minAge !== undefined && 
                        (state.age < event.requirements.minAge || state.age > event.requirements.maxAge)) {
                        return false;
                    }
                    
                    // Job requirements
                    if (event.requirements.hasJob && !state.job) return false;
                    if (event.requirements.jobType && state.job !== event.requirements.jobType) return false;
                    
                    // Relationship requirements
                    if (event.requirements.isSingle && state.relationships.some(r => r.status === "married")) return false;
                    if (event.requirements.isMarried && !state.relationships.some(r => r.status === "married")) return false;
                    if (event.requirements.hasFriends && !state.relationships.some(r => ["friend", "good_friend", "best_friend"].includes(r.status))) return false;
                    
                    // Stat requirements
                    if (event.requirements.minSmarts && state.stats.smarts < event.requirements.minSmarts) return false;
                    if (event.requirements.minHealth && state.stats.health < event.requirements.minHealth) return false;
                    if (event.requirements.minHappiness && state.stats.happiness < event.requirements.minHappiness) return false;
                    if (event.requirements.minLooks && state.stats.looks < event.requirements.minLooks) return false;
                    
                    // Education requirements
                    if (event.requirements.hasHighSchool && !state.education?.highSchool) return false;
                    if (event.requirements.hasCollege && !state.education?.college) return false;
                    
                    // Asset/Money requirements
                    if (event.requirements.minMoney && state.money < event.requirements.minMoney) return false;
                    if (event.requirements.hasHouse && !state.assets?.house) return false;
                    if (event.requirements.hasCar && !state.assets?.car) return false;
                }
                
                // Check if the event is repeatable or has not been fired yet
                if (!event.repeatable && firedEvents.has(event.title || event.message)) {
                    return false;
                }
                
                return true;
            });
            
            // Debug log to see eligible events
            console.log("Eligible events:", eligibleEvents);
            
            const weightedEvents = eligibleEvents.flatMap(event => 
                Array(event.weight || 1).fill(event)
            );
            
            const selectedEvent = weightedEvents[Math.floor(Math.random() * weightedEvents.length)];
            
            // Mark the event as fired
            if (selectedEvent) {
                firedEvents.add(selectedEvent.title || selectedEvent.message);
            }
            
            return selectedEvent;
        }

        function updateAvatar() {
            const maleAvatars = {
                0: 'üë∂',  // Baby
                3: 'üë¶',  // Child
                13: 'üë®', // Teen
                20: 'üë®', // Adult
                60: 'üë¥'  // Elder
            };

            const femaleAvatars = {
                0: 'üë∂',  // Baby
                3: 'üëß',  // Child
                13: 'üë©', // Teen
                20: 'üë©', // Adult
                60: 'üëµ'  // Elder
            };

            const avatars = state.gender === "Male" ? maleAvatars : femaleAvatars;

            state.avatar = Object.entries(avatars).reduce((acc, [age, emoji]) => {
                return state.age >= age ? emoji : acc;
            }, state.avatar);
        }

        function applyEventEffects(effects) {
            // Store the original stats for comparison
            const originalStats = { ...state.stats };
            const statChanges = {};
            
            Object.entries(effects).forEach(([stat, value]) => {
                if (stat === 'money') {
                    state.money += value;  // Update money
                    statChanges.money = value;
                } else {
                    // Store the change amount
                    statChanges[stat] = value;
                    state.stats[stat] = Math.max(0, Math.min(100, state.stats[stat] + value));
                }
            });
            
            // Animate the stat changes
            animateStatChanges(statChanges);
            
            updateUI();  // Ensure UI is updated after applying effects
            
            return statChanges; // Return the changes for logging
        }

        // New function to animate stat changes
        function animateStatChanges(changes) {
            Object.entries(changes).forEach(([stat, value]) => {
                if (value === 0) return; // Skip if no change
                
                // Handle money specially since it doesn't have its own element with ID "money"
                if (stat === 'money') {
                    const moneyElement = document.getElementById('character-money');
                    if (moneyElement) {
                        // Create animation element
                        const animElement = document.createElement('div');
                        animElement.className = `stat-change ${value > 0 ? 'positive' : 'negative'}`;
                        animElement.textContent = value > 0 ? `+$${value}` : `-$${Math.abs(value)}`;
                        animElement.style.position = 'absolute';
                        
                        // Position it near the money display
                        moneyElement.style.position = 'relative';
                        moneyElement.appendChild(animElement);
                        
                        // Remove the element after animation completes
                        setTimeout(() => {
                            animElement.remove();
                        }, 1500);
                    }
                    return;
                }
                
                const statElement = document.getElementById(stat);
                if (!statElement) return; // Skip if element not found
                
                // Add highlight effect to the stat element
                statElement.classList.add('highlight');
                setTimeout(() => {
                    statElement.classList.remove('highlight');
                }, 500);
                
                // Create animation element
                const animElement = document.createElement('div');
                animElement.className = `stat-change ${value > 0 ? 'positive' : 'negative'}`;
                animElement.textContent = value > 0 ? `+${value}` : value;
                
                // Position it in the center of the stat element
                statElement.appendChild(animElement);
                
                // Remove the element after animation completes
                setTimeout(() => {
                    animElement.remove();
                }, 1500);
            });
        }

        // UI Updates
        function updateUI() {
            document.getElementById('avatar').textContent = state.avatar;
            document.getElementById('character-name').textContent = state.name;
            
            // Update age display to show both age and global year
            const globalYear = getGlobalYear();
            document.getElementById('character-age').textContent = `Age: ${state.age}, Year: ${globalYear}`;
            
            document.getElementById('character-money').textContent = `Money: $${state.money}`;
            document.getElementById('happiness').textContent = `Happiness: ${state.stats.happiness}`;
            document.getElementById('health').textContent = `Health: ${state.stats.health}`;
            document.getElementById('smarts').textContent = `Smarts: ${state.stats.smarts}`;
            document.getElementById('looks').textContent = `Looks: ${state.stats.looks}`;
            
            // Update character stats table with visibility logic
            const statsMapping = {
                'char-gender': state.gender,
                'char-personality': state.personality,
                'char-job': state.job,
                'char-education': state.education,
                'char-memory': state.childhoodMemory,
                'char-color': state.favoriteColor,
                'char-fear': state.greatestFear,
                'char-friend': state.bestFriend,
                'char-subject': state.favoriteSubject,
                'char-talents': state.talents.length ? state.talents.join(", ") : null,
                'char-hobbies': state.hobbies.length ? state.hobbies.join(", ") : null,
                'char-dreams': state.dreams,
                'char-quirk': state.quirk
            };

            // Update each stat and show/hide its row
            for (const [elementId, value] of Object.entries(statsMapping)) {
                const element = document.getElementById(elementId);
                const row = element.closest('tr'); // Get the parent table row
                
                if (value) {
                    // Show and update rows with values
                    row.style.display = '';
                    element.textContent = value;
                } else {
                    // Hide empty rows
                    row.style.display = 'none';
                }
            }

            // Update relationships display
            const relationshipsList = document.getElementById('relationships-list');
            relationshipsList.innerHTML = ''; // Clear existing relationships

            if (state.relationships.length === 0) {
                relationshipsList.innerHTML = '<div class="relationship-item">No relationships yet</div>';
            } else {
                state.relationships.forEach(rel => {
                    const relationshipEmoji = getRelationshipEmoji(rel.status);
                    const relationshipDiv = document.createElement('div');
                    relationshipDiv.className = 'relationship-item';
                    relationshipDiv.innerHTML = `
                        <span>${relationshipEmoji} ${getCharacterDisplayName(rel.person)}</span>
                        <span class="relationship-status">${formatRelationshipStatus(rel.status)}</span>
                        <span class="relationship-level">Relationship Score: ${rel.level}</span>
                    `;
                    relationshipsList.appendChild(relationshipDiv);
                });
            }
        }

        // Main Game Loop
        function advanceYear() {
            // Increment the global year and update the player's age and all characters' ages.
            advanceYearAndAges();
            
            const event = getRandomEvent();
            
            if (!event) {
                console.warn("No eligible event found for the current state.");
                return;
            }
            
            console.log("Event fired:", event.title || event.message);
            
            if (event.choices) {
                // New format event with choices
                showChoice(event);
            } else {
                // Old format event
                const statChanges = applyEventEffects(event.effect);
                if (event.onTrigger) {
                    event.onTrigger(state);
                }
                
                // Create stat impact text
                let statImpactHTML = '';
                if (Object.keys(statChanges).length > 0) {
                    statImpactHTML = '<div class="stat-impact">';
                    Object.entries(statChanges).forEach(([stat, value]) => {
                        if (value === 0) return;
                        const formattedStat = stat.charAt(0).toUpperCase() + stat.slice(1);
                        const sign = value > 0 ? '+' : '';
                        statImpactHTML += `${formattedStat}: ${sign}${value} `;
                    });
                    statImpactHTML += '</div>';
                }
                
                const log = document.getElementById('story-log');
                log.insertAdjacentHTML('afterbegin', 
                    `<div><strong>Age ${state.age}</strong>: ${event.message || event.description}${statImpactHTML}</div>`
                );
            }
            
            updateAvatar();
            
            if (!checkDeath()) {
                updateUI();
            }
        }

        // Initial setup
        updateUI();

        function checkDeath() {
            if (state.stats.health <= 0) {
                state.causeOfDeath = "Poor health";
                showDeathModal();
                return true;
            }
            return false;
        }

        function showDeathSequenceAndThenStartNewLife() {
            // Retrieve the current death count from localStorage
            let currentDeathCount = parseInt(localStorage.getItem("deathCount") || "0");
            currentDeathCount++;
            localStorage.setItem("deathCount", currentDeathCount.toString());

            const dialogKey = `death${currentDeathCount}`;

            // Show the dialog for "deathN"
            showDialog(dialogKey, {
                onDone: () => {
                    // At the end, actually start a new life
                    startNewLife();
                }
            });
        }

        function showDeathModal() {
            const modal = document.getElementById('deathModal');
            const statsDiv = document.getElementById('deathStats');
            
            // Calculate lifetime stats
            const statsHTML = `
                <p>Age at death: ${state.age} years</p>
                <p>Born in year: ${state.birthYear}</p>
                <p>Died in year: ${getGlobalYear()}</p>
                <p>Final Stats:</p>
                <p>Happiness: ${state.stats.happiness}</p>
                <p>Health: ${state.stats.health}</p>
                <p>Smarts: ${state.stats.smarts}</p>
                <p>Looks: ${state.stats.looks}</p>
                <p>Cause of death: ${state.causeOfDeath}</p>
                <p>You've played ${getTotalYearsPlayed()} total years</p>
            `;
            
            statsDiv.innerHTML = statsHTML;
            modal.style.display = 'flex';

            // Instead of immediately "startNewLife," chain your new function:
            // Optionally, hide the normal "Start New Life" button or
            // replace its onclick with showDeathSequenceAndThenStartNewLife()
            const newLifeButton = modal.querySelector(".new-life-btn");
            newLifeButton.onclick = showDeathSequenceAndThenStartNewLife;
        }

        function startNewLife() {
            // Save the current town
            const currentTown = state.town;
            
            // Reset the global year to 0
            resetGlobalYear();
            
            // Reset the game state
            state = initializeState();
            
            // Restore the town
            state.town = currentTown;
            
            // Get and display the new life number.
            const lifeNumber = (parseInt(localStorage.getItem("deathCount") || "0")) + 1;
            console.log(`Starting Life #${lifeNumber} in the year 0`);
            
            // Clear the story log
            const log = document.getElementById('story-log');
            log.innerHTML = '';
            
            // Hide the death modal
            document.getElementById('deathModal').style.display = 'none';
            
            // Reset the fired events set
            // We can remove this if we decide to keep the events from firing multiple times
            firedEvents = new Set();
            
            // Update UI
            updateUI();
        }

        // Add choice handling functions
        function showChoice(event) {
            const modal = document.getElementById('choiceModal');
            const title = document.getElementById('choiceTitle');
            const description = document.getElementById('choiceDescription');
            const buttonsContainer = document.getElementById('choiceButtons');
            
            title.textContent = event.title || 'Make a Choice';
            description.textContent = typeof event.description === 'function' 
                ? event.description(state) 
                : event.description;
            
            buttonsContainer.innerHTML = '';
            
            event.choices.forEach(choice => {
                const button = document.createElement('button');
                button.className = 'choice-button';
                button.textContent = choice.text;
                button.onclick = () => {
                    handleChoice(choice, event);
                    modal.style.display = 'none';
                };
                buttonsContainer.appendChild(button);
            });
            
            modal.style.display = 'flex';
        }

        function handleChoice(choice, event) {
            const statChanges = applyEventEffects(choice.effect);
            
            if (choice.onSelect) {
                choice.onSelect(state, event);
            }
            
            const resultText = typeof choice.result === 'function' 
                ? choice.result(state, event) 
                : choice.result;
            
            // Create stat impact text
            let statImpactHTML = '';
            if (Object.keys(statChanges).length > 0) {
                statImpactHTML = '<div class="stat-impact">';
                Object.entries(statChanges).forEach(([stat, value]) => {
                    if (value === 0) return;
                    const formattedStat = stat.charAt(0).toUpperCase() + stat.slice(1);
                    const sign = value > 0 ? '+' : '';
                    statImpactHTML += `${formattedStat}: ${sign}${value} `;
                });
                statImpactHTML += '</div>';
            }
            
            const log = document.getElementById('story-log');
            log.insertAdjacentHTML('afterbegin', 
                `<div><strong>Age ${state.age}</strong>: ${resultText}${statImpactHTML}</div>`
            );
            
            updateUI();
        }

        // Helper functions for relationship management
        function getRandomStranger(state) {
            return state.potentialRelationships.find(person => 
                !state.relationships.some(rel => rel.person.id === person.id)
            );
        }

        function getRandomFriend(state) {
            const friends = state.relationships.filter(rel => 
                ["friend", "good_friend", "best_friend"].includes(rel.status)
            );
            return friends[Math.floor(Math.random() * friends.length)]?.person;
        }

        function addRelationship(state, person, status, level) {
            state.relationships.push({
                person: person,
                status: status,
                level: level || 0
            });
        }

        function upgradeRelationship(state, person, newStatus) {
            const rel = state.relationships.find(r => r.person.id === person.id);
            if (rel) {
                rel.status = newStatus;
                rel.level += 10;
            }
        }

        function downgradeRelationship(state, person) {
            const rel = state.relationships.find(r => r.person.id === person.id);
            if (rel) {
                rel.level -= 10;
                if (rel.level < 0) {
                    rel.status = "enemy";
                }
            }
        }

        function addRelationshipPoints(state, person, points) {
            const rel = state.relationships.find(r => r.person.id === person.id);
            if (rel) {
                rel.level += points;
            }
        }

        // Helper function to get emoji for relationship status
        function getRelationshipEmoji(status) {
            const emojis = {
                'stranger': 'ü§î',
                'acquaintance': 'üëã',
                'friend': 'üòä',
                'good_friend': 'ü§ó',
                'best_friend': 'üí´',
                'enemy': 'üò†',
                'dating': 'üíï',
                'married': 'üíë',
                'divorced': 'üíî'
            };
            return emojis[status] || 'üë§';
        }

        // Helper function to format relationship status
        function formatRelationshipStatus(status) {
            return status.split('_')
                .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                .join(' ');
        }

        // Call this once on page load to initialize the dialog UI container
        initDialogSystem();

        // Example: Modify your showDeathModal or wherever you do "Game Over":
        function showDeathSequenceAndThenStartNewLife() {
            // Retrieve the current death count from localStorage
            let currentDeathCount = parseInt(localStorage.getItem("deathCount") || "0");
            currentDeathCount++;
            localStorage.setItem("deathCount", currentDeathCount.toString());

            const dialogKey = `death${currentDeathCount}`;

            // Show the dialog for "deathN"
            showDialog(dialogKey, {
                onDone: () => {
                    // At the end, actually start a new life
                    startNewLife();
                }
            });
        }

        // CHEATS FOR TESTING

        // Cheat to trigger an event by title
        // triggerEventByTitle("Birth");
        function triggerEventByTitle(title) {
            const event = events.find(e => e.title === title);
            
            if (!event) {
                console.warn(`Event with title "${title}" not found.`);
                return;
            }
            
            console.log(`Triggering event: ${event.title}`);
            
            if (event.choices) {
                // Show the choice modal for events with choices
                showChoice(event);
            } else {
                // Apply the event's effects directly
                const statChanges = applyEventEffects(event.effect);
                if (event.onTrigger) {
                    event.onTrigger(state);
                }
                
                // Create stat impact text
                let statImpactHTML = '';
                if (Object.keys(statChanges).length > 0) {
                    statImpactHTML = '<div class="stat-impact">';
                    Object.entries(statChanges).forEach(([stat, value]) => {
                        if (value === 0) return;
                        const formattedStat = stat.charAt(0).toUpperCase() + stat.slice(1);
                        const sign = value > 0 ? '+' : '';
                        statImpactHTML += `${formattedStat}: ${sign}${value} `;
                    });
                    statImpactHTML += '</div>';
                }
                
                // Log the event in the story log
                const log = document.getElementById('story-log');
                log.insertAdjacentHTML('afterbegin', 
                    `<div><strong>Age ${state.age}</strong>: ${event.message}${statImpactHTML}</div>`
                );
            }
            
            updateAvatar();
            updateUI();
        }        

        // Change your age by calling setAge(25);
        function setAge(newAge) {
            if (typeof newAge !== 'number' || newAge < 0) {
                console.warn("Invalid age. Please enter a non-negative number.");
                return;
            }
            
            state.age = newAge;
            console.log(`Age set to: ${state.age}`);
            
            // Update the avatar and UI to reflect the new age
            updateAvatar();
            updateUI();
        }

        // Dialog System
        

        // Add these functions after your existing JavaScript
        function showJobPanel() {
            console.log("Job panel clicked");
            // Implementation coming soon
        }

        function showAssetsPanel() {
            console.log("Assets panel clicked");
            // Implementation coming soon
        }

        function showRelationshipsPanel() {
            // We can reuse your existing characters modal functionality here
            console.log("Relations button clicked");
            updateCharactersModal();
            console.log("Modal updated, displaying now");
            document.getElementById('charactersModal').style.display = 'block';
        }

        function showStatsPanel() {
            console.log("Stats panel clicked");
            // Implementation coming soon
        }

        // Add this helper function
        function getCharacterDisplayName(person) {
            return person.name || `${person.firstName} ${person.lastName}` || "Unknown";
        }

        // New helper functions
        function showPreviousEventResult(event) {
            const modal = document.getElementById('eventResultModal');
            modal.innerHTML = `
                <h3>${event.title}</h3>
                <p>This happened to you before in year ${getGlobalYear()}:</p>
                <p>${event.result}</p>
                <button onclick="closeEventModal()">Continue</button>
            `;
            modal.style.display = 'block';
        }

        function findEligibleReceiver(requirement) {
            switch (requirement) {
                case RelationshipRequirement.SPOUSE:
                    return state.relationships.find(rel => rel.status === 'married')?.person;
                case RelationshipRequirement.FRIEND:
                    return state.relationships.find(rel => 
                        ['friend', 'good_friend', 'best_friend'].includes(rel.status)
                    )?.person;
                // ... other relationship types ...
                default:
                    return null;
            }
        }

        // Add a new function to take over an existing character
        function takeOverCharacter(characterIndex) {
            if (!state.town || !state.town[characterIndex]) {
                console.error("Character not found");
                return;
            }
            
            const character = state.town[characterIndex];
            console.log(`Taking over character: ${character.name}`);
            
            // Save the current town without the character we're taking over
            const currentTown = state.town.filter((_, index) => index !== characterIndex);
            
            // Create a new state based on the character
            state = {
                name: character.name,
                gender: character.gender,
                personality: character.personality,
                age: character.age,
                avatar: character.gender === "Male" ? 'üë®' : 'üë©', // Set appropriate avatar based on age
                stats: { ...character.stats },
                money: character.money || 0,
                job: character.job || null,
                education: character.education || null,
                childhoodMemory: character.childhoodMemory || null,
                favoriteColor: character.favoriteColor || null,
                greatestFear: character.greatestFear || null,
                relationships: character.relationships || [],
                achievements: character.achievements || [],
                talents: character.talents || [],
                dreams: character.dreams || null,
                bestFriend: character.bestFriend || null,
                favoriteSubject: character.favoriteSubject || null,
                hobbies: character.hobbies || [],
                causeOfDeath: null,
                quirk: character.quirk || "Has a mysterious past",
                pets: character.pets || [],
                potentialRelationships: Array(10).fill(null).map(() => generatePerson()),
                eventHistory: new EventHistory(),
                town: currentTown,
                birthYear: getGlobalYear() - character.age
            };
            
            // Update avatar based on age
            updateAvatar();
            
            // Clear the story log
            const log = document.getElementById('story-log');
            log.innerHTML = '';
            
            // Add an entry about taking over this character
            log.insertAdjacentHTML('afterbegin', 
                `<div><strong>Age ${state.age}</strong>: You have taken over the life of ${state.name}, who is ${state.age} years old.</div>`
            );
            
            // Update UI
            updateUI();
            
            return state;
        }

    </script>
</body>
</html>